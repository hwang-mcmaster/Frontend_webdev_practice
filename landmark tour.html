<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landmarks Map</title>
  <style>
    #map { width: 100%; height: 60vh; }
    img { margin: 4px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <hr>

  <input id="title" placeholder="Title"> <br>
  <textarea id="desc" placeholder="Description (1 to 3 sentences)"></textarea> <br>

  <input type="file" id="img" accept="image/*" multiple> <br>

  <button id="geo">Use my location</button> <br>

  <input id="lat" placeholder="Latitude"> <br>
  <input id="lng" placeholder="Longitude"> <br>

  <button id="add">Add landmark</button>

  <div id="preview"></div>

  <script>
    const images = []
    const landmarks = []

    const titleEl = document.getElementById("title")
    const descEl = document.getElementById("desc")
    const imgEl = document.getElementById("img")
    const previewEl = document.getElementById("preview")
    const latEl = document.getElementById("lat")
    const lngEl = document.getElementById("lng")

    let map = null
    let infoWindow = null

    function handleImageChange() {
      previewEl.innerHTML = ""
      images.length = 0

      for (const file of imgEl.files) {
        images.push(file)

        const pic = document.createElement("img")
        pic.src = URL.createObjectURL(file)
        pic.width = 120
        previewEl.appendChild(pic)
      }
    }

    imgEl.addEventListener("change", handleImageChange)

    function countSentences(text) {
      const parts = text.split(/[.!?]+/)
      let count = 0

      for (let i = 0; i < parts.length; i++) {
        const sentence = parts[i].trim()
        if (sentence !== "") count++
      }
      return count
    }

    function handleGeoClick() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported")
        return
      }

      navigator.geolocation.getCurrentPosition(function (pos) {
        latEl.value = pos.coords.latitude
        lngEl.value = pos.coords.longitude
      }, function () {
        alert("Could not get location")
      })
    }

    document.getElementById("geo").addEventListener("click", handleGeoClick)

    function makeInfoHtml(lm) {
      let html = ""
      html += "<h3>" + lm.title + "</h3>"
      html += "<p>" + lm.desc + "</p>"
      html += "<div>Lat: " + lm.lat + " Lng: " + lm.lng + "</div>"

      for (let i = 0; i < lm.files.length; i++) {
        const url = URL.createObjectURL(lm.files[i])
        html += "<img src='" + url + "' width='140'>"
      }

      return html
    }

    function addMarkerForLandmark(lm) {
      const marker = new google.maps.Marker({
        map: map,
        position: { lat: lm.lat, lng: lm.lng },
        title: lm.title
      })

      marker.addListener("click", function () {
        infoWindow.setContent(makeInfoHtml(lm))
        infoWindow.open(map, marker)
      })
    }

    function handleAddClick() {
      const title = titleEl.value.trim()
      const desc = descEl.value.trim()
      const lat = Number(latEl.value)
      const lng = Number(lngEl.value)

      if (!title || !desc || images.length === 0) {
        alert("Need title, description, and at least 1 image")
        return
      }

      const sCount = countSentences(desc)
      if (sCount < 1 || sCount > 3) {
        alert("Description must be 1 to 3 sentences")
        return
      }

      if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
        alert("Need valid latitude and longitude")
        return
      }

      const lm = {
        title: title,
        desc: desc,
        files: images.slice(),
        lat: lat,
        lng: lng
      }

      landmarks.push(lm)
      addMarkerForLandmark(lm)

      titleEl.value = ""
      descEl.value = ""
      imgEl.value = ""
      previewEl.innerHTML = ""
      images.length = 0
    }

    document.getElementById("add").addEventListener("click", handleAddClick)

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.6532, lng: -79.3832 },
        zoom: 10
      })
      infoWindow = new google.maps.InfoWindow()
    }

    window.initMap = initMap
  </script>

  <!-- Replace YOUR_API_KEY with your real key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=[mykey]&callback=initMap" async defer></script>
</body>
</html>
